<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Affiliate Builder · Kéo thả & dán link (GitHub Pages)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0b0c;--card:#121214;--muted:#9a9aa0;--text:#f3f3f4;--brand:#ff5a00;--brand2:#ff8640;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35);--max:1200px}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max);margin:auto;padding:0 16px}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(0deg,rgba(11,11,12,.7),rgba(11,11,12,.9));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
    .head{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:14px 0}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#111114;cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(255,90,0,.25),rgba(255,134,64,.25));border-color:rgba(255,134,64,.5)}

    /* shop cards */
    .filters{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:18px 0}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#111114;font-size:13px;cursor:pointer;opacity:.9}
    .chip.active{background:linear-gradient(135deg, rgba(255,90,0,.25), rgba(255,134,64,.25));border-color:rgba(255,134,64,.5)}
    select{appearance:none;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#111114;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{position:relative;aspect-ratio:16/10;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .5s ease}
    .card:hover .thumb img{transform:scale(1.06)}
    .discount{position:absolute;left:10px;top:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:6px 9px;border-radius:10px;font-weight:800;font-size:12px}
    .body{padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px}
    .title{font-weight:700;line-height:1.3}
    .meta{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:var(--muted)}
    .price{display:flex;align-items:center;gap:8px}
    .price .now{font-weight:800}
    .price .old{color:var(--muted);text-decoration:line-through}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:11px;border:1px dashed rgba(255,255,255,.15);padding:4px 8px;border-radius:999px;color:#cfcfd6}
    .actions{display:flex;gap:10px;margin-top:auto}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#131316;color:var(--text);cursor:pointer}
    .btn.buy{flex:1;justify-content:center;background:linear-gradient(135deg,var(--brand),var(--brand2));border:none;color:#fff;font-weight:800}
    .btn.view{flex:1;justify-content:center}

    /* editor */
    .editor{display:none}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .panel{background:#111114;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f0f11;color:var(--text);outline:none}
    textarea{min-height:86px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px dashed rgba(255,255,255,.12);border-radius:12px;background:#0f0f11}
    .item.dragging{opacity:.6}
    .thumb-sm{width:56px;height:42px;border-radius:8px;background:#1a1a1d;overflow:hidden}
    .thumb-sm img{width:100%;height:100%;object-fit:cover}
    .actions-sm{display:flex;gap:8px}
    .muted{color:var(--muted)}
    .bar{display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    footer{margin:32px 0;color:var(--muted);text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="container head">
      <div class="tabs">
        <button class="tab active" id="tabShop">Cửa hàng</button>
        <button class="tab" id="tabEditor">Trình biên tập</button>
      </div>
      <div class="bar">
        <button class="btn" id="btnImport">Nhập JSON</button>
        <input type="file" id="fileImport" class="hidden" accept="application/json" />
        <button class="btn" id="btnExport">Tải xuống products.json</button>
        <button class="btn" id="btnDownloadSite">Tải xuống index.html</button>
        <button class="btn" id="btnClear">Xoá dữ liệu tạm</button>
      </div>
    </div>
  </header>

  <!-- SHOP VIEW -->
  <main class="container" id="viewShop">
    <section class="filters">
      <div class="chips" id="chips"></div>
      <div>
        <select id="sort">
          <option value="popular">Phổ biến</option>
          <option value="new">Mới nhất</option>
          <option value="price-asc">Giá thấp → cao</option>
          <option value="price-desc">Giá cao → thấp</option>
        </select>
      </div>
    </section>
    <section id="results" class="grid"></section>
  </main>

  <!-- EDITOR VIEW -->
  <main class="container editor" id="viewEditor">
    <div class="row">
      <div class="panel">
        <h2 style="margin:0 0 8px">Thêm / Sửa sản phẩm</h2>
        <div class="grid-2">
          <div>
            <label>Tên sản phẩm</label>
            <input id="name" placeholder="VD: UI Kit Figma"/>
          </div>
          <div>
            <label>Danh mục</label>
            <input id="cat" placeholder="VD: Template">
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>Giá hiện tại</label>
            <input id="price" type="number" step="0.01" placeholder="19">
          </div>
          <div>
            <label>Giá cũ</label>
            <input id="oldPrice" type="number" step="0.01" placeholder="39">
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>Ảnh (URL)</label>
            <input id="img" placeholder="https://...jpg">
          </div>
          <div>
            <label>Link đích (dán link)</label>
            <input id="url" placeholder="https://...">
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>Tags (phân cách bởi dấu phẩy)</label>
            <input id="tags" placeholder="Template, Design">
          </div>
          <div>
            <label>Độ phổ biến (số)</label>
            <input id="popular" type="number" placeholder="120">
          </div>
        </div>
        <div class="grid-2">
          <div>
            <label>Ngày (YYYY-MM-DD)</label>
            <input id="date" placeholder="2025-10-01">
          </div>
          <div>
            <label>ID (tự tạo nếu để trống)</label>
            <input id="pid" placeholder="tpl-fig-01">
          </div>
        </div>
        <div class="bar" style="margin-top:12px">
          <button class="btn" id="btnAdd">Lưu sản phẩm</button>
          <button class="btn" id="btnReset">Xoá form</button>
        </div>
        <p class="muted" style="margin-top:8px">Mẹo: chỉ việc <strong>dán link</strong> vào ô “Link đích”, các thông số khác có thể bổ sung sau. Tất cả lưu tạm trong trình duyệt (localStorage).</p>
      </div>
      <div class="panel">
        <h2 style="margin:0 0 8px">Danh sách (kéo thả để sắp xếp)</h2>
        <div id="list" class="list"></div>
      </div>
    </div>
  </main>

  <footer class="container"><p class="muted">Made for GitHub Pages · Hoàn toàn tĩnh, không cần server.</p></footer>

  <script>
    // ===== STATE & UTIL =====
    const KEY = 'affiliate_products_v1';
    let PRODUCTS = load() || sample();

    function save(){ localStorage.setItem(KEY, JSON.stringify(PRODUCTS)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||''); }catch(e){ return null } }
    function uid(){ return 'p-' + Math.random().toString(36).slice(2,8); }
    function money(n){ try{ return Number(n).toLocaleString('vi-VN',{style:'currency',currency:'VND'}).replace('₫','đ'); }catch(e){ return n } }
    function ensureUtm(url, pid){ if(!url) return '#'; const u = new URL(url); if(!u.searchParams.get('utm_source')){ u.searchParams.set('utm_source','shop'); u.searchParams.set('utm_medium','ref'); u.searchParams.set('utm_campaign', pid||'item'); } return u.toString(); }

    // ===== SHOP RENDER =====
    const elResults = document.getElementById('results');
    const elChips = document.getElementById('chips');
    const elSort = document.getElementById('sort');

    function categories(){ const set = new Set(PRODUCTS.map(p=>p.cat||'Khác')); return ['Tất cả', ...Array.from(set)]; }

    function buildChips(){ elChips.innerHTML=''; categories().forEach((c,i)=>{ const b = document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=c; b.dataset.cat=c; b.onclick=()=>{ document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderShop(); }; elChips.appendChild(b); }); }

    function filtered(){ const cat = document.querySelector('.chip.active')?.dataset.cat || 'Tất cả'; let arr=[...PRODUCTS]; if(cat!=='Tất cả') arr=arr.filter(p=> (p.cat||'Khác')===cat); const s=elSort.value; if(s==='new') arr.sort((a,b)=> new Date(b.date||0)-new Date(a.date||0)); else if(s==='price-asc') arr.sort((a,b)=> (a.price||0)-(b.price||0)); else if(s==='price-desc') arr.sort((a,b)=> (b.price||0)-(a.price||0)); else arr.sort((a,b)=> (b.popular||0)-(a.popular||0)); return arr }

    function card(p){ const now = p.price? money(p.price*1000):'Liên hệ'; const old = p.oldPrice? money(p.oldPrice*1000):''; const disc = (p.price&&p.oldPrice)? ('-'+Math.round((1-p.price/p.oldPrice)*100)+'%') : '';
      const link = ensureUtm(p.url, p.id);
      return `<article class="card" draggable="false">
        <div class="thumb"><img src="${p.img||''}" alt="${p.name||''}" loading="lazy"/>${disc?`<span class="discount">${disc}</span>`:''}</div>
        <div class="body">
          <div class="title">${p.name||'Sản phẩm chưa đặt tên'}</div>
          <div class="meta"><div class="price"><span class="now">${now}</span> ${old?`<span class="old">${old}</span>`:''}</div><div>Đã bán ${p.popular||0}</div></div>
          <div class="tags">${(p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          <div class="actions"><a class="btn view" href="${link}" target="_blank" rel="noopener">Xem chi tiết</a><a class="btn buy" href="${link}" target="_blank" rel="noopener">Mua ngay</a></div>
        </div></article>` }

    function renderShop(){ buildChips(); elResults.innerHTML = filtered().map(card).join(''); }

    // ===== EDITOR RENDER =====
    const list = document.getElementById('list');
    function renderList(){ list.innerHTML=''; PRODUCTS.forEach((p,i)=>{ const el = document.createElement('div'); el.className='item'; el.draggable=true; el.dataset.index=i;
      el.innerHTML = `<div class="thumb-sm">${p.img?`<img src="${p.img}">`:''}</div><div><div style="font-weight:700">${p.name||'(chưa đặt tên)'}</div><div class="muted" style="font-size:12px">${p.cat||'Khác'} · ${p.price?money(p.price*1000):'Giá ?'}</div></div><div class="actions-sm"><button class="btn" data-act="edit">Sửa</button><button class="btn" data-act="del">Xoá</button></div>`;
      el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', i.toString()); });
      el.addEventListener('dragend', ()=> el.classList.remove('dragging'));
      list.appendChild(el);
    });
    // drag container
    list.ondragover = (e)=>{ e.preventDefault(); const after = getDragAfterElement(list, e.clientY); const dragging = document.querySelector('.item.dragging'); if(!dragging) return; if(after==null) list.appendChild(dragging); else list.insertBefore(dragging, after); };
    list.ondrop = ()=>{ // commit order
      const items = Array.from(list.querySelectorAll('.item')); const ordered=[]; items.forEach(it=>{ ordered.push(PRODUCTS[Number(it.dataset.index)]) }); PRODUCTS=ordered; save(); renderShop(); renderList(); };

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return; const parent = e.target.closest('.item'); const i = Number(parent.dataset.index);
      if(btn.dataset.act==='del'){ PRODUCTS.splice(i,1); save(); renderShop(); renderList(); fillForm(); }
      if(btn.dataset.act==='edit'){ fillForm(PRODUCTS[i]); }
    });
    }

    function getDragAfterElement(container, y){ const els = [...container.querySelectorAll('.item:not(.dragging)')]; return els.reduce((closest, child)=>{ const box = child.getBoundingClientRect(); const offset = y - box.top - box.height/2; if(offset<0 && offset>closest.offset){ return {offset, element: child}; } else { return closest } }, {offset: Number.NEGATIVE_INFINITY}).element; }

    // ===== FORM =====
    const f = {
      name: document.getElementById('name'),
      cat: document.getElementById('cat'),
      price: document.getElementById('price'),
      oldPrice: document.getElementById('oldPrice'),
      img: document.getElementById('img'),
      url: document.getElementById('url'),
      tags: document.getElementById('tags'),
      popular: document.getElementById('popular'),
      date: document.getElementById('date'),
      pid: document.getElementById('pid')
    };

    function fillForm(p={}){ f.name.value=p.name||''; f.cat.value=p.cat||''; f.price.value=p.price||''; f.oldPrice.value=p.oldPrice||''; f.img.value=p.img||''; f.url.value=p.url||''; f.tags.value=(p.tags||[]).join(', '); f.popular.value=p.popular||''; f.date.value=p.date||''; f.pid.value=p.id||''; }

    document.getElementById('btnReset').onclick = ()=> fillForm({});
    document.getElementById('btnAdd').onclick = ()=>{
      const p = {
        id: f.pid.value.trim() || uid(),
        name: f.name.value.trim(),
        price: Number(f.price.value||0),
        oldPrice: Number(f.oldPrice.value||0),
        img: f.img.value.trim(),
        url: f.url.value.trim(),
        tags: f.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
        cat: f.cat.value.trim()||'Khác',
        popular: Number(f.popular.value||0),
        date: f.date.value.trim()||new Date().toISOString().slice(0,10)
      };
      const idx = PRODUCTS.findIndex(x=>x.id===p.id);
      if(idx>-1) PRODUCTS[idx]=p; else PRODUCTS.push(p);
      save(); renderShop(); renderList(); fillForm({});
    };

    // ===== IMPORT / EXPORT =====
    document.getElementById('btnExport').onclick = ()=>{
      const blob = new Blob([JSON.stringify(PRODUCTS,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'products.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    document.getElementById('btnImport').onclick = ()=> document.getElementById('fileImport').click();
    document.getElementById('fileImport').onchange = (e)=>{ const file=e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ PRODUCTS=JSON.parse(r.result); save(); renderShop(); renderList(); }catch(err){ alert('File JSON không hợp lệ'); } }; r.readAsText(file); };

    // Generate a standalone index.html that fetches products from products.json
    document.getElementById('btnDownloadSite').onclick = ()=>{
      const html = generateSiteHTML().replaceAll('</script>','<\/script>');
      const blob = new Blob([html], {type:'text/html'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'index.html'; a.click(); URL.revokeObjectURL(a.href);
    };

    document.getElementById('btnClear').onclick = ()=>{ if(confirm('Xoá dữ liệu tạm (localStorage)?')){ localStorage.removeItem(KEY); PRODUCTS = sample(); renderShop(); renderList(); fillForm({}); } };

    // ===== TABS =====
    const tabShop = document.getElementById('tabShop');
    const tabEditor = document.getElementById('tabEditor');
    const viewShop = document.getElementById('viewShop');
    const viewEditor = document.getElementById('viewEditor');
    tabShop.onclick = ()=>{ tabShop.classList.add('active'); tabEditor.classList.remove('active'); viewShop.style.display='block'; viewEditor.style.display='none'; };
    tabEditor.onclick = ()=>{ tabEditor.classList.add('active'); tabShop.classList.remove('active'); viewEditor.style.display='block'; viewShop.style.display='none'; };

    // ===== INIT =====
    renderShop(); renderList(); fillForm({});

    // ===== TEMPLATE GENERATOR =====
    function generateSiteHTML(){
      const safeProducts = JSON.stringify(PRODUCTS);
      return `<!DOCTYPE html><html lang=\"vi\"><head><meta charset=\"utf-8\"/><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/><title>Cửa hàng · Sản phẩm số</title><style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0b0c;color:#f3f3f4;margin:0}a{text-decoration:none;color:inherit}.container{max-width:1200px;margin:auto;padding:0 16px}.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}@media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}@media(max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}@media(max-width:520px){.grid{grid-template-columns:1fr}}.card{background:#121214;border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden}.thumb{aspect-ratio:16/10;overflow:hidden}.thumb img{width:100%;height:100%;object-fit:cover;display:block}.body{padding:12px}.title{font-weight:700}.meta{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#9a9aa0}.price{display:flex;gap:8px}.old{text-decoration:line-through;color:#9a9aa0}.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#131316;color:#f3f3f4;margin-right:8px}.buy{background:linear-gradient(135deg,#ff5a00,#ff8640);border:none;color:#fff;font-weight:800}</style></head><body><main class=\"container\"><section id=\"results\" class=\"grid\"></section></main><script>const PRODUCTS=${safeProducts};function money(n){try{return Number(n).toLocaleString('vi-VN',{style:'currency',currency:'VND'}).replace('₫','đ')}catch(e){return n}}function ensureUtm(url,pid){if(!url) return '#'; const u=new URL(url); if(!u.searchParams.get('utm_source')){u.searchParams.set('utm_source','shop');u.searchParams.set('utm_medium','ref');u.searchParams.set('utm_campaign',pid||'item')} return u.toString()}function card(p){const now=p.price?money(p.price*1000):'Liên hệ';const old=p.oldPrice?money(p.oldPrice*1000):'';const link=ensureUtm(p.url,p.id);return \`<article class=\\\"card\\\"><div class=\\\"thumb\\\"><img src=\\\"\${p.img||''}\\\"></div><div class=\\\"body\\\"><div class=\\\"title\\\">\${p.name||''}</div><div class=\\\"meta\\\"><div class=\\\"price\\\">\${now} \${old?\`<span class=\\\\\\\"old\\\\\\\">\${old}</span>\`:''}</div><div>Đã bán \${p.popular||0}</div></div><div style=\\\"margin-top:8px\\\"><a class=\\\"btn\\\" href=\\\"\${link}\\\" target=\\\"_blank\\\" rel=\\\"noopener\\\">Xem chi tiết</a><a class=\\\"btn buy\\\" href=\\\"\${link}\\\" target=\\\"_blank\\\" rel=\\\"noopener\\\">Mua ngay</a></div></div></article>\` }document.getElementById('results').innerHTML = PRODUCTS.map(card).join('');</script></body></html>`;
    }

    function sample(){ return [
      { id:"tpl-fig-01", name:"UI Kit Shop – Figma", price:19, oldPrice:39, img:"https://images.unsplash.com/photo-1547658719-da2b51169166?q=80&w=1200&auto=format&fit=crop", tags:["Template","Design"], cat:"Template", popular:98, date:"2025-10-01", url:"https://example.com/figma-uikit" },
      { id:"ebook-ai-01", name:"Ebook: AI Prompt Mastery", price:9, oldPrice:19, img:"https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=1200&auto=format&fit=crop", tags:["Ebook","AI"], cat:"Ebook", popular:76, date:"2025-08-15", url:"https://example.com/ai-prompt" }
    ]; }
  </script>
</body>
</html>
